# N-Lossless Mixed Compression

This folder evaluates a **mixed strategy**:
- First N layers use **lossless** compression
- Remaining layers use **lightweight lossy** compression

The implementation is **offline only** and consumes existing KV dumps.

## Dependencies
- Python 3
- `numpy`
- `zstandard`

```bash
pip install numpy zstandard
```

## Inputs
You can reuse dumps generated by `exp/gear_fp16` (FP16 recommended).
Example dump root:
```
exp/gear_fp16/dumps_fp16/<run_id>/
```

## Run (single dump root)
```bash
python3 exp/n_lossless/analyze_mixed.py \
  --dump-dir exp/gear_fp16/dumps_fp16/demo_20260205_102843_prompt_128_1 \
  --out-dir exp/n_lossless/out/demo_20260205_102843_prompt_128_1 \
  --stage both \
  --lossless-first-n 2 \
  --lossy-mantissa-bits 6 \
  --compress-mode gear-delta \
  --zstd-level 3
```

## Outputs
- `mixed_layer_metrics.csv` — per-layer ratios with lossless/lossy flag
- `lossy_error_metrics.csv` — MAE/RMSE/max_abs/cosine on lossy layers
- `mixed_summary.md` — weighted ratios for overall / lossless / lossy

## Notes
- `lossless-first-n` defines the split point.
- `lossy-mantissa-bits` controls truncation strength for FP16/FP32.
- `compress-mode` can be `gear`, `gear-delta`, or `zstd`.
