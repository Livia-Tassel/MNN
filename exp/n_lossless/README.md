# N-Lossless Mixed Compression

This folder evaluates a **mixed strategy**:
- First N layers use **lossless** compression
- Remaining layers use **lightweight lossy** compression

The implementation is **offline only** and consumes existing KV dumps.

## Dependencies
- Python 3
- `numpy`
- `zstandard`

```bash
pip install numpy zstandard
```

## Inputs
You can reuse dumps generated by `exp/gear_fp16` (FP16 recommended).
Example dump root:
```
exp/gear_fp16/dumps_fp16/<run_id>/
```

## Run (single dump root)
```bash
python3 exp/n_lossless/analyze_mixed.py \
  --dump-dir exp/gear_fp16/dumps_fp16/demo_20260205_102843_prompt_128_1 \
  --out-dir exp/n_lossless/out/demo_20260205_102843_prompt_128_1 \
  --stage both \
  --lossless-first-n 2 \
  --lossy-method quant \
  --lossy-bits 8 \
  --compress-mode gear-delta \
  --zstd-level 3
```

## Outputs
- `mixed_layer_metrics.csv` — per-layer ratios with lossless/lossy flag
- `lossy_error_metrics.csv` — MAE/RMSE/max_abs/cosine on lossy layers
- `mixed_summary.md` — weighted ratios for overall / lossless / lossy

## Block-Norm (Partial De-Normalization)
This script evaluates **block normalization + partial de-normalization (top-k blocks)**.

```bash
python3 exp/n_lossless/analyze_blocknorm.py \
  --dump-dir exp/gear_fp16/dumps_fp16/demo_20260205_102843_prompt_128_1 \
  --out-dir exp/n_lossless/out/demo_20260205_102843_prompt_128_1_blocknorm \
  --stage both \
  --lossless-first-n 2 \
  --block-size 256 \
  --topk-ratio 0.05 \
  --bits 10 \
  --scale-bytes 2 \
  --topk-extra-scale-bytes 4 \
  --compress-mode gear-delta \
  --zstd-level 3
```

Outputs:
- `blocknorm_metrics.csv`
- `blocknorm_summary.md`

## Block-Norm Sweep (Find Best Trade-off)
Sweeps a grid of parameters and reports the best combinations.

```bash
python3 exp/n_lossless/sweep_blocknorm.py \
  --dump-dir exp/gear_fp16/dumps_fp16/demo_20260205_102843_prompt_128_1 \
  --out-dir exp/n_lossless/out/blocknorm_sweep_20260205_170000 \
  --stage both \
  --lossless-first-n 2 \
  --block-sizes 64,128,256 \
  --topk-ratios 0.02,0.05,0.1 \
  --bits-list 8,10 \
  --scale-bytes 2 \
  --topk-extra-scale-bytes 4 \
  --compress-mode gear-delta \
  --zstd-level 3 \
  --min-k-cosine 0.9999 \
  --min-v-cosine 0.9999 \
  --max-k-mae 0.01 \
  --max-v-mae 0.002
```

Outputs:
- `blocknorm_sweep.csv`
- `blocknorm_best.md`

## Lossy Compare (clip + quantize)
This script evaluates **outlier clipping + uniform quantization** on lossy layers.

```bash
python3 exp/n_lossless/analyze_lossy_compare.py \
  --dump-dir exp/gear_fp16/dumps_fp16/demo_20260205_102843_prompt_128_1 \
  --out-dir exp/n_lossless/out/demo_20260205_102843_prompt_128_1_lossy \
  --stage both \
  --lossless-first-n 2 \
  --bits-list 4,6,8,10 \
  --clip-percentiles 1,99 \
  --clip-sigma 3.0 \
  --modes clip,quant,clip-quant \
  --clip-method both \
  --compress-mode gear-delta \
  --zstd-level 3
```

Outputs:
- `lossy_compare.csv`
- `lossy_compare_summary.md`

## Notes
- `lossless-first-n` defines the split point.
- `lossy-mantissa-bits` controls truncation strength for FP16/FP32.
- `compress-mode` can be `gear`, `gear-delta`, or `zstd`.
